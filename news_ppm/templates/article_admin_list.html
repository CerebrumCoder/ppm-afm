{% extends "base.html" %}

{% block title %}Admin Artikel AFM{% endblock %}

{% block content %}
<section class="py-6">
  <div class="mx-auto max-w-6xl">
    <!-- HEADER -->
    <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
      <div>
        <h1 class="text-lg font-semibold sm:text-xl">Admin Artikel AFM</h1>
        <p class="mt-1 text-xs text-slate-600 dark:text-slate-300">
          Kelola berita & pengumuman PPM Al-Faqih Mandiri.
        </p>
        <a
          href="{% url 'change_password' %}"
          class="mt-2 inline-flex items-center rounded-full border border-slate-300 px-3 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800"
        >
          Ubah password saya
        </a>
      </div>

      <a
        href="{% url 'news:article_admin_create' %}"
        class="inline-flex items-center rounded-full bg-[var(--nav-link-color-active)] px-4 py-2 text-xs font-semibold text-[var(--primary-color)] shadow hover:bg-lime-300"
      >
        + Tambah Artikel
      </a>
    </div>

    <!-- LIST ARTIKEL -->
    {% if articles %}
      <!-- DESKTOP/TABLET: TABEL -->
      <div class="hidden nav:block overflow-hidden rounded-2xl border border-slate-200 bg-white/95 shadow-sm dark:border-slate-700 dark:bg-slate-900/80">
        <table class="min-w-full text-left text-xs sm:text-sm">
          <thead class="bg-slate-900/80 text-slate-100">
            <tr>
              <th class="px-3 py-2 hidden md:table-cell">Thumbnail</th>
              <th class="px-3 py-2">Judul</th>
              <th class="px-3 py-2 hidden sm:table-cell">Kategori</th>
              <th class="px-3 py-2 hidden md:table-cell">Tanggal</th>
              <th class="px-3 py-2">Status</th>
              <th class="px-3 py-2 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for article in articles %}
              <tr class="border-t border-slate-200/70 dark:border-slate-700/60">
                <!-- Thumbnail -->
                <td class="px-3 py-2 align-top hidden md:table-cell">
                  {% if article.thumbnail %}
                    <img src="{{ article.thumbnail.url }}" alt="{{ article.title }}" class="h-10 w-16 rounded-md object-cover">
                  {% elif article.thumbnail_url %}
                    <img src="{{ article.thumbnail_url }}" alt="{{ article.title }}" class="h-10 w-16 rounded-md object-cover">
                  {% else %}
                    <span class="text-[11px] text-slate-400">-</span>
                  {% endif %}
                </td>

                <!-- Judul -->
                <td class="px-3 py-2 align-top">
                  <div
                    class="max-w-xs text-[11px] font-medium sm:max-w-sm sm:text-xs md:max-w-md md:text-sm"
                    title="{{ article.title }}"
                  >
                    {{ article.title|truncatewords:2 }}
                  </div>
                  <div class="text-[10px] text-slate-500 dark:text-slate-400">
                    ID: {{ article.pk }}
                  </div>
                </td>

                <!-- Kategori -->
                <td class="px-3 py-2 align-top hidden sm:table-cell">
                  {{ article.category.name|default:"-" }}
                </td>

                <!-- Tanggal -->
                <td class="px-3 py-2 align-top hidden md:table-cell">
                  {% if article.published_at %}
                    {{ article.published_at|date:"j M Y" }}
                  {% else %}
                    -
                  {% endif %}
                </td>

                <!-- Status (Toggle pill + modal konfirmasi) -->
                <td class="px-3 py-2 align-top">
                  <div
                    class="inline-flex items-center rounded-full bg-slate-200/60 px-0.5 py-0.5 text-[11px] dark:bg-slate-800/70"
                    data-status-url="{% url 'news:article_set_status' article.pk %}"
                    data-article-title="{{ article.title }}"
                  >
                    <!-- Draft -->
                    <button
                      type="button"
                      class="status-pill px-3 py-0.5 rounded-full font-semibold border
                             {% if not article.is_published %}
                               bg-amber-100 text-amber-800 border-amber-300
                               dark:bg-amber-500/30 dark:text-amber-100 dark:border-amber-400
                             {% else %}
                               bg-transparent text-slate-600 border-transparent
                               dark:text-slate-300 dark:border-transparent
                             {% endif %}"
                      data-value="draft"
                    >
                      Draft
                    </button>

                    <!-- Published -->
                    <button
                      type="button"
                      class="status-pill px-3 py-0.5 rounded-full font-semibold border
                             {% if article.is_published %}
                               bg-emerald-100 text-emerald-800 border-emerald-300
                               dark:bg-emerald-500/30 dark:text-emerald-100 dark:border-emerald-400
                             {% else %}
                               bg-transparent text-slate-600 border-transparent
                               dark:text-slate-300 dark:border-transparent
                             {% endif %}"
                      data-value="published"
                    >
                      Published
                    </button>
                  </div>
                </td>

                <!-- Aksi -->
                <td class="px-3 py-2 align-top text-right">
                  <a
                    href="{% url 'news:article_admin_edit' article.pk %}"
                    class="text-[11px] font-semibold text-[var(--nav-link-color-active)] hover:underline"
                  >
                    Edit
                  </a>
                  <span class="mx-1 text-[11px] text-slate-400">|</span>
                  <button
                    type="button"
                    class="text-[11px] text-red-500 hover:underline delete-link"
                    data-delete-url="{% url 'news:article_admin_delete' article.pk %}"
                    data-article-title="{{ article.title }}"
                  >
                    Hapus
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- MOBILE: CARD CAROUSEL -->
      <div class="mt-4 nav:hidden">
        <div class="admin-articles-carousel flex gap-3 overflow-x-auto pb-2">
          {% for article in articles %}
            <div class="min-w-[260px] max-w-[280px] rounded-2xl border border-slate-200 bg-white p-4 text-xs text-slate-900 shadow-sm
                        dark:border-slate-700 dark:bg-[#050b16] dark:text-slate-100">
              <div class="mb-2 space-y-0.5">
                <p class="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Artikel
                </p>
                <p class="max-w-[220px] truncate text-sm font-semibold" title="{{ article.title }}">
                  {{ article.title|truncatewords:2 }}
                </p>
                <p class="text-[10px] text-slate-500 dark:text-slate-400">
                  ID: {{ article.pk }}
                </p>
              </div>

              {% if article.thumbnail %}
                <div class="mb-3 overflow-hidden rounded-xl border border-slate-300 bg-slate-100 dark:border-slate-700 dark:bg-slate-900">
                  <img src="{{ article.thumbnail.url }}" alt="{{ article.title }}" class="h-24 w-full object-cover">
                </div>
              {% elif article.thumbnail_url %}
                <div class="mb-3 overflow-hidden rounded-xl border border-slate-300 bg-slate-100 dark:border-slate-700 dark:bg-slate-900">
                  <img src="{{ article.thumbnail_url }}" alt="{{ article.title }}" class="h-24 w-full object-cover">
                </div>
              {% endif %}

              <div class="mb-2 text-[10px] text-slate-500 dark:text-slate-400 space-y-0.5">
                <p>Kategori:
                  <span class="text-slate-900 dark:text-slate-100">
                    {{ article.category.name|default:"-" }}
                  </span>
                </p>
                <p>Tanggal:
                  <span class="text-slate-900 dark:text-slate-100">
                    {% if article.published_at %}
                      {{ article.published_at|date:"j M Y" }}
                    {% else %}
                      -
                    {% endif %}
                  </span>
                </p>
              </div>

              <div class="mb-3">
                {% if article.is_published %}
                  <span class="inline-flex rounded-full bg-emerald-500/10 px-3 py-0.5 text-[11px] font-semibold text-emerald-700 border border-emerald-300
                                dark:bg-emerald-500/20 dark:text-emerald-200 dark:border-emerald-400/60">
                    Published
                  </span>
                {% else %}
                  <span class="inline-flex rounded-full bg-amber-500/10 px-3 py-0.5 text-[11px] font-semibold text-amber-700 border border-amber-300
                                dark:bg-amber-500/20 dark:text-amber-200 dark:border-amber-400/60">
                    Draft
                  </span>
                {% endif %}
              </div>

              <div class="flex items-center justify-between text-[11px]">
                <a
                  href="{% url 'news:article_admin_edit' article.pk %}"
                  class="font-semibold text-[var(--nav-link-color-active)] hover:underline"
                >
                  Edit
                </a>
                <button
                  type="button"
                  class="text-red-500 hover:underline dark:text-red-400"
                  data-delete-url="{% url 'news:article_admin_delete' article.pk %}"
                  data-article-title="{{ article.title }}"
                >
                  Hapus
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="text-xs text-slate-500 dark:text-slate-300">
        Belum ada artikel.
      </p>
    {% endif %}

    <!-- STATISTIK MAHASISWA -->
    <section class="mt-8 max-w-xl">
      <h2 class="mb-2 text-sm font-semibold">Statistik Mahasiswa di Beranda</h2>

      <form id="stats-form"
            method="post"
            action="{% url 'news:update_stats' %}"
            class="grid grid-cols-2 gap-3 rounded-2xl border border-slate-200 bg-white p-4 text-xs
                   dark:border-slate-700 dark:bg-[#050b16]">
        {% csrf_token %}

        <div>
          <label class="mb-1 block text-xs font-medium text-slate-700 dark:text-slate-100">
            Dewan Guru
          </label>
          <input
            type="text"
            id="stats-dewan"
            name="dewan_guru"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-xs text-slate-900 shadow-sm
                   focus:border-[var(--nav-link-color-active)] focus:outline-none focus:ring-2 focus:ring-[var(--nav-link-color-active)]/50
                   dark:border-slate-600 dark:bg-slate-900 dark:text-slate-50"
          />
          <p class="mt-1 text-[10px] text-slate-500 dark:text-slate-400">
            Saat ini: {{ stats.dewan_guru|default:0 }}
          </p>
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-slate-700 dark:text-slate-100">
            Total Mahasiswa (otomatis)
          </label>
          <input
            type="text"
            id="stats-total"
            readonly
            class="w-full rounded-xl border border-slate-300 bg-slate-100 px-3 py-2 text-xs text-slate-800 shadow-sm
                   dark:border-slate-600 dark:bg-slate-800 dark:text-slate-50"
          />
          <p class="mt-1 text-[10px] text-slate-500 dark:text-slate-400">
            Saat ini: {{ stats.total_mahasiswa|default:0 }}
          </p>
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-slate-700 dark:text-slate-100">
            Mahasiswa (laki-laki)
          </label>
          <input
            type="text"
            id="stats-mahasiswa"
            name="mahasiswa"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-xs text-slate-900 shadow-sm
                   focus:border-[var(--nav-link-color-active)] focus:outline-none focus:ring-2 focus:ring-[var(--nav-link-color-active)]/50
                   dark:border-slate-600 dark:bg-slate-900 dark:text-slate-50"
          />
          <p class="mt-1 text-[10px] text-slate-500 dark:text-slate-400">
            Saat ini: {{ stats.mahasiswa|default:0 }}
          </p>
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-slate-700 dark:text-slate-100">
            Mahasiswi (perempuan)
          </label>
          <input
            type="text"
            id="stats-mahasiswi"
            name="mahasiswi"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-xs text-slate-900 shadow-sm
                   focus:border-[var(--nav-link-color-active)] focus:outline-none focus:ring-2 focus:ring-[var(--nav-link-color-active)]/50
                   dark:border-slate-600 dark:bg-slate-900 dark:text-slate-50"
          />
          <p class="mt-1 text-[10px] text-slate-500 dark:text-slate-400">
            Saat ini: {{ stats.mahasiswi|default:0 }}
          </p>
        </div>

        <div class="col-span-2 pt-2">
          <button
            type="submit"
            class="rounded-full bg-[var(--nav-link-color-active)] px-4 py-1.5 text-xs font-semibold text-[var(--primary-color)] shadow hover:bg-lime-300">
            Simpan Statistik
          </button>
          <span id="stats-status" class="ml-2 text-[11px] text-slate-400"></span>
        </div>
      </form>
    </section>

  </div>
</section>

<!-- MODAL HAPUS -->
<div id="delete-modal"
     class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60">
  <div class="w-full max-w-sm rounded-3xl bg-[#050b16] p-5 text-sm text-slate-100 shadow-lg dark:bg-slate-900">
    <h2 class="mb-2 text-base font-semibold">Hapus artikel?</h2>
    <p class="mb-3 text-xs text-slate-300">
      Artikel <span id="delete-article-title" class="font-semibold"></span> akan dihapus permanen.
    </p>
    <div class="flex justify-end gap-2 text-xs">
      <button
        type="button"
        id="delete-cancel"
        class="rounded-full border border-slate-500 px-3 py-1 font-medium text-slate-200 hover:bg-slate-800"
      >
        Batal
      </button>
      <button
        type="button"
        id="delete-confirm"
        class="rounded-full bg-red-600 px-3 py-1 font-medium text-white hover:bg-red-700"
      >
        Ya, hapus
      </button>
    </div>
  </div>
</div>

<!-- MODAL UBAH STATUS -->
<div id="status-modal"
     class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black/60">
  <div class="w-full max-w-sm rounded-3xl bg-[#050b16] p-5 text-sm text-slate-100 shadow-lg dark:bg-slate-900">
    <h2 class="mb-2 text-base font-semibold">Ubah status artikel?</h2>
    <p class="mb-1 text-xs text-slate-300">
      Artikel <span id="status-article-title" class="font-semibold"></span> akan di-set menjadi
      <span id="status-target-label" class="font-semibold text-[var(--nav-link-color-active)]"></span>.
    </p>
    <p class="mb-3 text-[11px] text-slate-400">
      Tindakan ini hanya mengubah apakah artikel tampil di halaman publik atau tidak.
    </p>
    <div class="flex justify-end gap-2 text-xs">
      <button
        type="button"
        id="status-cancel"
        class="rounded-full border border-slate-500 px-3 py-1 font-medium text-slate-200 hover:bg-slate-800"
      >
        Batal
      </button>
      <button
        type="button"
        id="status-confirm"
        class="rounded-full bg-emerald-600 px-3 py-1 font-medium text-white hover:bg-emerald-700"
      >
        Ya, ubah status
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  /* ---- Statistik: auto total + AJAX submit ---- */
  const statsForm = document.getElementById("stats-form");
  const inputMahasiswa = document.getElementById("stats-mahasiswa");
  const inputMahasiswi = document.getElementById("stats-mahasiswi");
  const inputTotal = document.getElementById("stats-total");

  function recalcTotal() {
    const a = parseInt(inputMahasiswa?.value, 10) || 0;
    const b = parseInt(inputMahasiswi?.value, 10) || 0;
    if (inputTotal) inputTotal.value = a + b;
  }

  if (inputMahasiswa && inputMahasiswi && inputTotal) {
    inputMahasiswa.addEventListener("input", recalcTotal);
    inputMahasiswi.addEventListener("input", recalcTotal);
  }

  if (statsForm) {
    statsForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const statusEl = document.getElementById("stats-status");
      fetch(statsForm.action, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: new FormData(statsForm),
      })
      .then(r => r.json())
      .then(data => {
        if (!statusEl) return;
        if (data.ok) {
          statusEl.textContent = "Tersimpan.";
          statusEl.classList.remove("text-red-500");
          statusEl.classList.add("text-emerald-500");
        } else {
          statusEl.textContent = "Gagal menyimpan.";
          statusEl.classList.remove("text-emerald-500");
          statusEl.classList.add("text-red-500");
        }
      })
      .catch(() => {
        if (!statusEl) return;
        statusEl.textContent = "Terjadi kesalahan.";
        statusEl.classList.remove("text-emerald-500");
        statusEl.classList.add("text-red-500");
      });
    });
  }

  /* ---- MODAL UBAH STATUS Draft/Published ---- */
  const statusModal = document.getElementById("status-modal");
  const statusTitle = document.getElementById("status-article-title");
  const statusTargetLabel = document.getElementById("status-target-label");
  const statusCancel = document.getElementById("status-cancel");
  const statusConfirm = document.getElementById("status-confirm");

  let pendingStatus = null;  // "draft" / "published"
  let pendingGroup = null;   // wrapper div
  let pendingUrl = null;     // AJAX URL

  document.querySelectorAll("[data-status-url]").forEach(group => {
    const url = group.dataset.statusUrl;
    const articleTitle = group.dataset.articleTitle || "";

    group.querySelectorAll(".status-pill").forEach(btn => {
      btn.addEventListener("click", function () {
        const newStatus = btn.dataset.value;

        pendingStatus = newStatus;
        pendingGroup = group;
        pendingUrl = url;

        if (statusTitle) statusTitle.textContent = articleTitle;
        if (statusTargetLabel) {
          statusTargetLabel.textContent = (newStatus === "draft") ? "Draft" : "Published";
        }

        if (statusModal) statusModal.classList.remove("hidden");
      });
    });
  });

  function resetStatusModal() {
    pendingStatus = null;
    pendingGroup = null;
    pendingUrl = null;
    if (statusModal) statusModal.classList.add("hidden");
  }

  if (statusCancel && statusModal) {
    statusCancel.addEventListener("click", resetStatusModal);
  }

  if (statusModal) {
    statusModal.addEventListener("click", function (e) {
      if (e.target === statusModal) resetStatusModal();
    });
  }

  if (statusConfirm) {
    statusConfirm.addEventListener("click", function () {
      if (!pendingUrl || !pendingGroup || !pendingStatus) {
        resetStatusModal();
        return;
      }

      fetch(pendingUrl, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: new URLSearchParams({ status: pendingStatus }),
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          pendingGroup.querySelectorAll(".status-pill").forEach(b => {
            const value = b.dataset.value;

            if (value === "draft" && pendingStatus === "draft") {
              b.className =
                "status-pill px-3 py-0.5 rounded-full font-semibold border " +
                "bg-amber-100 text-amber-800 border-amber-300 " +
                "dark:bg-amber-500/30 dark:text-amber-100 dark:border-amber-400";
            } else if (value === "published" && pendingStatus === "published") {
              b.className =
                "status-pill px-3 py-0.5 rounded-full font-semibold border " +
                "bg-emerald-100 text-emerald-800 border-emerald-300 " +
                "dark:bg-emerald-500/30 dark:text-emerald-100 dark:border-emerald-400";
            } else {
              b.className =
                "status-pill px-3 py-0.5 rounded-full font-semibold border " +
                "bg-transparent text-slate-600 border-transparent " +
                "dark:text-slate-300 dark:border-transparent";
            }
          });
        }
        resetStatusModal();
      })
      .catch(() => {
        resetStatusModal();
      });
    });
  }

  /* ---- Modal Hapus Artikel ---- */
  const deleteModal = document.getElementById("delete-modal");
  const deleteTitle = document.getElementById("delete-article-title");
  const deleteCancel = document.getElementById("delete-cancel");
  const deleteConfirm = document.getElementById("delete-confirm");
  let deleteUrl = null;
  let deleteRow = null;

  document.querySelectorAll(".delete-link").forEach(btn => {
    btn.addEventListener("click", function () {
      deleteUrl = btn.dataset.deleteUrl;
      deleteRow = btn.closest("tr") || btn.closest(".min-w-[260px]"); // row tabel atau card
      if (deleteTitle) {
        deleteTitle.textContent = btn.dataset.articleTitle || "";
      }
      if (deleteModal) deleteModal.classList.remove("hidden");
    });
  });

  if (deleteCancel && deleteModal) {
    deleteCancel.addEventListener("click", function () {
      deleteModal.classList.add("hidden");
    });
  }

  if (deleteModal) {
    deleteModal.addEventListener("click", function (e) {
      if (e.target === deleteModal) {
        deleteModal.classList.add("hidden");
      }
    });
  }

  if (deleteConfirm) {
    deleteConfirm.addEventListener("click", function () {
      if (!deleteUrl) return;
      fetch(deleteUrl, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok && deleteRow) {
          deleteRow.remove();
        }
        if (deleteModal) deleteModal.classList.add("hidden");
      })
      .catch(() => {
        if (deleteModal) deleteModal.classList.add("hidden");
      });
    });
  }
});
</script>
{% endblock %}
